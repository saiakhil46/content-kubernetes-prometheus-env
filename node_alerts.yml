groups:
- name: node.alertrules
  rules:
  - alert: node_down
    expr: up{job="host-details"} == 0
    for: 1m
    labels:
      severity: "FATAL"
      service: "node"
    annotations:
      description: "Node with hostname {{ $labels.nodename }} and ip {{ $labels.instance }} is down"
      summary: "NODE IS DOWN {{ $labels.nodename }}"
  - alert: node_high_cpu_usage_on_node_WARNING
    expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{job="host-details",mode="idle"}[5m])) * 100) >= 70 and (avg by (instance) (irate(node_cpu_seconds_total{job="vm-node-exporter",mode="idle"}[5m])) * 100) < 75
    for: 1m
    labels:
      severity: WARNING
      service: "node"
    annotations:
      description: '{{ $labels.instance }} is using a LOT of CPU. CPU usage is {{ humanize $value}}%.'
      summary: 'HIGH CPU USAGE WARNING ON {{ $labels.instance }}'
  - alert: node_high_cpu_usage_on_node_CRITICAL
    expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{job="vm-host-details",mode="idle"}[5m])) * 100) >= 75 and (avg by (instance) (irate(node_cpu_seconds_total{job="vm-node-exporter",mode="idle"}[5m])) * 100) < 80
    for: 1m
    labels:
      severity: CRITICAL
      service: "node"
    annotations:
      description: '{{ $labels.instance }} is using a LOT of CPU. CPU usage is {{ humanize $value}}%.'
      summary: 'HIGH CPU USAGE WARNING ON {{ $labels.instance }}'
  - alert: node_high_cpu_usage_on_node_FATAL
    expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{job="host-details",mode="idle"}[5m])) * 100) >= 80
    for: 1m
    labels:
      severity: FATAL
      service: "node"
    annotations:
      description: '{{ $labels.instance }} is using a LOT of CPU. CPU usage is {{ humanize $value}}%.'
      summary: 'HIGH CPU USAGE WARNING ON {{ $labels.instance }}'
  - alert: node_high_memory_usage_on_node_WARNING
    expr: ((((node_memory_MemTotal_bytes{instance!="prod-server:9110"} - node_memory_MemAvailable_bytes{instance!="prod-server:9110"}) / node_memory_MemTotal_bytes{instance!="prod-server:9110"}) * 100) >= 85 and (((node_memory_MemTotal_bytes{instance!="prod-server:9110"} - node_memory_MemAvailable_bytes{instance!="prod-server:9110"}) / node_memory_MemTotal_bytes{instance!="prod-server:9110"}) * 100) < 90 )
    for: 1m
    labels:
      severity: WARNING
      service: "node"
    annotations:
      description: '{{ $labels.instance }} is using a LOT of MEMORY. MEMORY usage is over {{ humanize $value}}.'
      summary: 'HIGH MEMORY USAGE WARNING TASK ON {{ $labels.instance }}'
  - alert: node_high_memory_usage_on_node_CRITICAL
    expr: ((((node_memory_MemTotal_bytes{instance!="prod-server:9110"} - node_memory_MemAvailable_bytes{instance!="prod-server:9110"}) / node_memory_MemTotal_bytes{instance!="prod-server:9110"}) * 100) >= 90 and (((node_memory_MemTotal_bytes{instance!="prod-server:9110"} - node_memory_MemAvailable_bytes{instance!="prod-server:9110"}) / node_memory_MemTotal_bytes{instance!="prod-server:9110"}) * 100) < 95 )
    for: 1m
    labels:
      severity: CRITICAL
      service: "node"
    annotations:
      description: '{{ $labels.instance }} is using a LOT of MEMORY. MEMORY usage is over {{ humanize $value}}.'
      summary: 'HIGH MEMORY USAGE WARNING TASK ON {{ $labels.instance }}'
  - alert: node_high_memory_usage_on_node_FATAL
    expr: (((node_memory_MemTotal_bytes{instance!="prod-server:9110"} - node_memory_MemAvailable_bytes{instance!="prod-server:9110"}) / node_memory_MemTotal_bytes{instance!="prod-server:9110"}) * 100) >= 95
    for: 1m
    labels:
      severity: FATAL
      service: "node"
    annotations:
      description: '{{ $labels.instance }}is using a LOT of MEMORY. MEMORY usage is over {{ humanize $value}}.'
      summary: 'HIGH MEMORY USAGE WARNING TASK ON {{ $labels.instance }}'
  - alert: node_high_memory_usage_on_prod_server_WARNING
    expr: ((((node_memory_MemTotal_bytes{instance="prod-server:9110"} - node_memory_MemAvailable_bytes{instance="prod-server:9110"}) / node_memory_MemTotal_bytes{instance="prod-server:9110"}) * 100) >= 40 and (((node_memory_MemTotal_bytes{instance="prod-server:9110"} - node_memory_MemAvailable_bytes{instance="prod-server:9110"}) / node_memory_MemTotal_bytes{instance="prod-server:9110"}) * 100) < 45 )
    for: 1m
    labels:
      severity: WARNING
      service: "node"
    annotations:
      description: '{{ $labels.instance }} is using a LOT of MEMORY. MEMORY usage is over {{ humanize $value}}.'
      summary: 'HIGH MEMORY USAGE WARNING TASK ON {{ $labels.instance }}'
  - alert: node_high_memory_usage_on_prod_server_CRITICAL
    expr: ((((node_memory_MemTotal_bytes{instance="prod-server:9110"} - node_memory_MemAvailable_bytes{instance="prod-server:9110"}) / node_memory_MemTotal_bytes{instance="prod-server:9110"}) * 100) >= 45 and (((node_memory_MemTotal_bytes{instance="prod-server:9110"} - node_memory_MemAvailable_bytes{instance="prod-server:9110"}) / node_memory_MemTotal_bytes{instance="prod-server:9110"}) * 100) < 50 )
    for: 1m
    labels:
      severity: CRITICAL
      service: "node"
    annotations:
      description: '{{ $labels.instance }} is using a LOT of MEMORY. MEMORY usage is over {{ humanize $value}}.'
      summary: 'HIGH MEMORY USAGE WARNING TASK ON {{ $labels.instance }}'
  - alert: node_high_memory_usage_on_prod_server_FATAL
    expr: (((node_memory_MemTotal_bytes{instance="prod-server:9110"} - node_memory_MemAvailable_bytes{instance="prod-server:9110"}) / node_memory_MemTotal_bytes{instance="prod-server:9110"}) * 100) >= 50
    for: 1m
    labels:
      severity: FATAL
      service: "node"
    annotations:
      description: '{{ $labels.instance }}is using a LOT of MEMORY. MEMORY usage is over {{ humanize $value}}.'
      summary: 'HIGH MEMORY USAGE WARNING TASK ON {{ $labels.instance }}'
  - alert: node_running_out_of_disk_space_WARNING
    expr: (((node_filesystem_size_bytes - node_filesystem_free_bytes) * 100 / node_filesystem_size_bytes) >= 97 and ((node_filesystem_size_bytes - node_filesystem_free_bytes) * 100 / node_filesystem_size_bytes) < 98 )
    for: 1m
    labels:
      severity: WARNING
      service: "node"
    annotations:
      description: 'Disk usage is {{ humanize $value }}% on mountpoint: {{$labels.mountpoint}}'
      summary: 'LOW DISK SPACE WARING: NODE {{ $labels.instance }}'
  - alert: node_running_out_of_disk_space_CRITICAL
    expr: (((node_filesystem_size_bytes - node_filesystem_free_bytes) * 100 / node_filesystem_size_bytes) >= 98 and ((node_filesystem_size_bytes - node_filesystem_free_bytes) * 100 / node_filesystem_size_bytes) < 99 )
    for: 1m
    labels:
      severity: CRITICAL
      service: "node"
    annotations:
      description: 'Disk usage is {{ humanize $value }}% on mountpoint: {{$labels.mountpoint}}'
      summary: 'LOW DISK SPACE WARING: NODE {{ $labels.instance }}'
  - alert: node_running_out_of_disk_space_FATAL
    expr: ((node_filesystem_size_bytes - node_filesystem_free_bytes) * 100 / node_filesystem_size_bytes) >= 99
    for: 1m
    labels:
      severity: FATAL
      service: "node"
    annotations:
      description: 'Disk usage is {{ humanize $value }}% on mountpoint: {{$labels.mountpoint}}'
      summary: 'LOW DISK SPACE WARING: NODE {{ $labels.instance }}'


